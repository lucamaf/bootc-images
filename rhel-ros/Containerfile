# Multi-stage build to properly handle ROS installation in bootc (not using opt)
FROM registry.redhat.io/rhel9/rhel-bootc:9.6 as ros-builder

ENV LANG=en_US.UTF-8

# Package dependencies for building (`sudo crb enable` does not work)
RUN dnf install -y curl dnf-plugins-core langpacks-en glibc-langpack-en \
    'dnf-command(config-manager)' \
    https://dl.fedoraproject.org/pub/epel/epel-release-latest-$(rpm -E %rhel).noarch.rpm && \
    env FORCE_DNF=1 crb enable && \
    dnf clean all

# Install ROS repository
RUN dnf install -y "https://github.com/ros-infrastructure/ros-apt-source/releases/download/$(curl -s https://api.github.com/repos/ros-infrastructure/ros-apt-source/releases/latest | grep -F "tag_name" | awk -F\" '{print $4}')/ros2-release-$(curl -s https://api.github.com/repos/ros-infrastructure/ros-apt-source/releases/latest | grep -F "tag_name" | awk -F\" '{print $4}')-1.noarch.rpm"

# Repo available only for major version
RUN tee /etc/yum.repos.d/ros2.repo <<'EOF'
[ros2]
name=ROS 2 - $basearch
enabled=1
baseurl=http://packages.ros.org/ros2/rhel/9/$basearch/
gpgcheck=0
repo_gpgcheck=0

[ros2-debug]
name=ROS 2 - $basearch Debug
enabled=0
baseurl=http://packages.ros.org/ros2/rhel/9/$basearch/debug/
gpgcheck=0
repo_gpgcheck=0

[ros2-source]
name=ROS 2 - Source
enabled=0
baseurl=http://packages.ros.org/ros2/rhel/9/SRPMS/
gpgcheck=0
repo_gpgcheck=0
EOF

# Install additional dependencies
RUN dnf install -y \
    spdlog-devel \
    lttng-ust \
    python3-typing-extensions \
    python3-numpy \
    python3-packaging \
    python3-psutil \
    python3-lark-parser \
    console-bridge-devel && \
    dnf clean all

# Install ROS desktop to default location (/opt)
RUN dnf install -y --releasever=9 ros-kilted-desktop && \
    dnf clean all



####################################################################################################################3
# Final stage - create the bootc image
FROM registry.redhat.io/rhel9/rhel-bootc:9.6

ENV LANG=en_US.UTF-8

# Install basic dependencies (without ROS-specific stuff)
RUN dnf install -y curl dnf-plugins-core langpacks-en glibc-langpack-en \
    'dnf-command(config-manager)' \
    https://dl.fedoraproject.org/pub/epel/epel-release-latest-$(rpm -E %rhel).noarch.rpm && \
    env FORCE_DNF=1 crb enable && \
    dnf clean all

# Install ROS repository configuration for potential future updates
RUN dnf install -y "https://github.com/ros-infrastructure/ros-apt-source/releases/download/$(curl -s https://api.github.com/repos/ros-infrastructure/ros-apt-source/releases/latest | grep -F "tag_name" | awk -F\" '{print $4}')/ros2-release-$(curl -s https://api.github.com/repos/ros-infrastructure/ros-apt-source/releases/latest | grep -F "tag_name" | awk -F\" '{print $4}')-1.noarch.rpm"

# Add ROS repository configuration
RUN tee /etc/yum.repos.d/ros2.repo <<'EOF'
[ros2]
name=ROS 2 - $basearch
enabled=1
baseurl=http://packages.ros.org/ros2/rhel/9/$basearch/
gpgcheck=0
repo_gpgcheck=0

[ros2-debug]
name=ROS 2 - $basearch Debug
enabled=0
baseurl=http://packages.ros.org/ros2/rhel/9/$basearch/debug/
gpgcheck=0
repo_gpgcheck=0

[ros2-source]
name=ROS 2 - Source
enabled=0
baseurl=http://packages.ros.org/ros2/rhel/9/SRPMS/
gpgcheck=0
repo_gpgcheck=0
EOF

# Install ROS dependencies that might be needed at runtime
RUN dnf install -y \
    spdlog-devel \
    lttng-ust \
    python3-typing-extensions \
    python3-numpy \
    python3-packaging \
    python3-psutil \
    python3-lark-parser \
    console-bridge-devel && \
    dnf clean all

# Install ROS desktop to default location (/opt)
RUN dnf install -y --releasever=9 ros-kilted-desktop && \
    dnf clean all

# Copy ROS installation from builder stage to /usr/local/ros
RUN mkdir -p /usr/local/ros
COPY --from=ros-builder /opt/ros /usr/local/ros

# Create compatibility symlink so software looking for /opt/ros still works
RUN ln -sf /usr/local/ros /opt/ros

# Set ROS environment variables
ENV ROS_DISTRO=kilted
ENV ROS_ROOT=/usr/local/ros/${ROS_DISTRO}
ENV PATH="${ROS_ROOT}/bin:${PATH}"
ENV LD_LIBRARY_PATH="${ROS_ROOT}/lib:${LD_LIBRARY_PATH}"

# Source ROS setup in bashrc for interactive shells and set dynamic PYTHONPATH
RUN echo "source /usr/local/ros/kilted/setup.bash" >> /etc/bashrc && \
    echo "export PYTHONPATH=\"${ROS_ROOT}/lib/\$(python3 -c \"import sys; print(f\\\"python{sys.version_info.major}.{sys.version_info.minor}\\\")\")/site-packages:\${PYTHONPATH}\"" >> /etc/bashrc


# (OPTIONAL) Uncomment if you need dev packages
#RUN dnf install -y cmake \
#    gcc-c++ \
#    git \
#    make \
#    patch \
#    python3-colcon-common-extensions \
#    python3-mypy \
#    python3-pip \
#    python3-pytest \
#    python3-pytest-repeat \
#    python3-pytest-rerunfailures \
#    python3-rosdep \
#    python3-setuptools \
#    python3-vcstool \
#    wget && \
#    python3 -m pip install -U --user \
#    flake8-blind-except==0.1.1 \
#    flake8-class-newline \
#    flake8-deprecated