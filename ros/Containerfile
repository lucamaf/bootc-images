FROM registry.redhat.io/rhel9/rhel-bootc:9.6

ENV LANG=en_US.UTF-8

# Package dependencies
RUN dnf install -y curl dnf-plugins-core langpacks-en glibc-langpack-en 'dnf-command(config-manager)' https://dl.fedoraproject.org/pub/epel/epel-release-latest-9.noarch.rpm  && \
    dnf config-manager --set-enabled codeready-builder-for-rhel-9-$(arch)-rpms && \
    dnf clean all

# Development tools
RUN dnf install -y \
        cmake \
        gcc-c++ \
        git \
        make \
        patch \
        python3-colcon-common-extensions \
        python3-mypy \
        python3-pip \
        python3-pytest \
        python3-pytest-cov \
        python3-pytest-mock \
        python3-pytest-repeat \
        python3-pytest-rerunfailures \
        python3-pytest-runner \
        python3-rosdep \
        python3-setuptools \
        python3-vcstool \
        wget && \
    python3 -m pip install -U --user \
        flake8-blind-except==0.1.1 \
        flake8-class-newline \
        flake8-deprecated && \
    dnf clean all

# Install ROS2 from source
RUN mkdir -p /root/ros2_kilted/src && \
    cd /root/ros2_kilted && \
    vcs import --input https://raw.githubusercontent.com/ros2/ros2/kilted/ros2.repos src

# Initialize rosdep and install dependencies
RUN rosdep init && \
    rosdep update && \
    cd /root/ros2_kilted && \
    rosdep install --from-paths src --ignore-src -y --skip-keys "fastcdr rti-connext-dds-7.3.0 urdfdom_headers" && \
    colcon build --symlink-install
