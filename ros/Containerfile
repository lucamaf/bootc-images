FROM registry.redhat.io/rhel9/rhel-bootc:9.6 

ENV LANG=en_US.UTF-8

# Package dependencies for building (`sudo crb enable` does not work)
RUN dnf install -y curl dnf-plugins-core langpacks-en glibc-langpack-en \
    'dnf-command(config-manager)' \
    https://dl.fedoraproject.org/pub/epel/epel-release-latest-$(rpm -E %rhel).noarch.rpm && \
    dnf config-manager --set-enabled codeready-builder-for-rhel-$(rpm -E %rhel)-$(arch)-rpms && \
    dnf clean all

RUN dnf install -y "https://github.com/ros-infrastructure/ros-apt-source/releases/download/$(curl -s https://api.github.com/repos/ros-infrastructure/ros-apt-source/releases/latest | grep -F "tag_name" | awk -F\" '{print $4}')/ros2-release-$(curl -s https://api.github.com/repos/ros-infrastructure/ros-apt-source/releases/latest | grep -F "tag_name" | awk -F\" '{print $4}')-1.noarch.rpm"

# Repo avialable only for major version
RUN tee /etc/yum.repos.d/ros2.repo <<'EOF'
[ros2]
name=ROS 2 - $basearch
enabled=1
baseurl=http://packages.ros.org/ros2/rhel/9/$basearch/
gpgcheck=0
repo_gpgcheck=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-ROS2

[ros2-debug]
name=ROS 2 - $basearch Debug
enabled=0
baseurl=http://packages.ros.org/ros2/rhel/9/$basearch/debug/
gpgcheck=0
repo_gpgcheck=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-ROS2

[ros2-source]
name=ROS 2 - Source
enabled=0
baseurl=http://packages.ros.org/ros2/rhel/9/SRPMS/
gpgcheck=0
repo_gpgcheck=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-ROS2
EOF


# Install ROS to a temporary location first pointing to major version (no minor versions in this repo)
RUN dnf install -y --releasever=9 --installroot=/tmp/ros-install ros-kilted-desktop && \
    dnf clean all

# Move ROS from /opt to /usr/local and create symlinks if needed
RUN if [ -d "/tmp/ros-install/opt/ros" ]; then \
        mkdir -p /usr/local/ros && \
        cp -r /tmp/ros-install/opt/ros/* /usr/local/ros/ && \
        ln -sf /usr/local/ros /opt/ros; \
    fi && \
    rm -rf /tmp/ros-install

# Update environment variables to point to new location
ENV ROS_DISTRO=kilted
ENV ROS_ROOT=/usr/local/ros/${ROS_DISTRO}
ENV PATH="${ROS_ROOT}/bin:${PATH}"
ENV LD_LIBRARY_PATH="${ROS_ROOT}/lib:${LD_LIBRARY_PATH}"
ENV PYTHONPATH="${ROS_ROOT}/lib/python3.9/site-packages:${PYTHONPATH}"

# Source ROS setup in bashrc for interactive shells
RUN echo "source /usr/local/ros/kilted/setup.bash" >> /etc/bashrc

